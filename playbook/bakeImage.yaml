- name: Create Production Template from Dev VM
  hosts: proxmox
  vars_files:
    - vars.yaml
    - vault.yaml

  tasks:
    - name: Create local shortcuts for VM variables
      set_fact:
        vm_id: "{{ hostvars[target_vm]['proxmox_vmid'] }}"
        vm_app: "{{ APPLICATION }}" 
        template_name: "{{ APPLICATION }}-golden"
        template_vmid: "{{ hostvars[target_vm]['proxmox_vmid'] }}0"

    - name: Check if old template exists
      shell: "qm status {{ template_vmid }}"
      register: template_check
      failed_when: false
      changed_when: false

    # - name: Handle existing template removal
    #   when: template_check.rc == 0
    #   block:
    #     - name: Unprotect Ceph snapshot
    #       shell: "rbd snap unprotect ceph/base-{{ template_vmid }}-disk-0@__base__"
    #       failed_when: false 

    #     - name: Destroy old template
    #       shell: "qm destroy {{ template_vmid }} --purge"
    
    - name: Clone Dev VM to a new Template ID
      shell: "qm clone {{ vm_id }} {{ template_vmid }} --full --name {{ template_name }}"

    - name: Ensure Guest Agent is enabled on clone
      shell: "qm set {{ template_vmid }} --agent 1"

    - name: Start the cloned VM
      community.general.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        api_host: "{{ inventory_hostname }}"
        vmid: "{{ template_vmid }}"
        state: started

    - name: Wait for Guest Agent to respond
      shell: "pvesh get /nodes/{{ inventory_hostname }}/qemu/{{ template_vmid }}/agent/ping"
      register: agent_ping
      until: agent_ping.rc == 0
      retries: 10
      delay: 5

    - name: Sanitize via Guest Agent (Targeting VMID, not IP)
      shell: |
        pvesh create /nodes/{{ inventory_hostname }}/qemu/{{ template_vmid }}/agent/exec --command "cloud-init clean --logs"
        pvesh create /nodes/{{ inventory_hostname }}/qemu/{{ template_vmid }}/agent/exec --command "truncate -s 0 /etc/machine-id"
        pvesh create /nodes/{{ inventory_hostname }}/qemu/{{ template_vmid }}/agent/exec --command "rm -f /etc/ssh/ssh_host_*"

    - name: Shutdown the clone
      community.general.proxmox_kvm:
        api_user: "{{ proxmox_api_user }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        api_host: "{{ inventory_hostname }}"
        vmid: "{{ template_vmid }}"
        state: stopped

    - name: Wait for VM to reach stopped state
      shell: "qm status {{ template_vmid }}"
      register: vm_status
      until: "'stopped' in vm_status.stdout"
      retries: 12
      delay: 5

    - name: Finalize conversion to Template
      shell: "qm template {{ template_vmid }}"