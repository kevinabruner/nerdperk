- name: Serial Rolling Deploy for Prod from golden images
  hosts: prod
  vars_files:
    - vars.yaml
    - vault.yaml
  serial: 1  # Forces one-by-one execution
  tasks:
  - name: Enable and stop apache2 and keepalived
    ansible.builtin.service:
      name: "{{ item }}"
      enabled: yes
      state: stopped
    loop:
      - apache2
      - keepalived
    become: true 

  - name: Copy keepalived configuration file
    become: true
    template:
      src: "{{ git_dir }}/templates/keepalived.conf.j2"
      dest: "/etc/keepalived/keepalived.conf"

  - name: Copy php settings file
    become: true
    template:
      src: "{{ git_dir }}/templates/settings.php.j2"
      dest: "/var/www/html/sites/default/settings.php"     

  - name: Start apache and keepalived
    ansible.builtin.systemd:
      name: "{{ item }}"
      enabled: yes
      state: started
    loop:
      - apache2
      - keepalived
    become: true